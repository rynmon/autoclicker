name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: autoclicker-windows-x86_64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: autoclicker-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: autoclicker-macos-aarch64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: autoclicker-linux-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxrandr-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libasound2-dev libxdo-dev

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          strip target/${{ matrix.target }}/release/autoclicker || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: target/${{ matrix.target }}/release/autoclicker${{ matrix.os == 'windows-latest' && '.exe' || '' }}
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: '*'
          merge-multiple: false

      - name: List downloaded artifacts
        run: |
          echo "Artifacts directory contents:"
          ls -la ./artifacts/ || echo "Artifacts directory not found"
          find ./artifacts -type f || echo "No files found"
          echo "Looking for executables:"
          find ./artifacts -name "autoclicker*" -type f || echo "No executables found"

      - name: Prepare release files
        run: |
          mkdir -p ./release-files
          # Copy files from artifact subdirectories to a flat structure
          if [ -f "./artifacts/autoclicker-windows-x86_64.exe/autoclicker-windows-x86_64.exe" ]; then
            cp "./artifacts/autoclicker-windows-x86_64.exe/autoclicker-windows-x86_64.exe" ./release-files/
          fi
          if [ -f "./artifacts/autoclicker-macos-x86_64/autoclicker-macos-x86_64" ]; then
            cp "./artifacts/autoclicker-macos-x86_64/autoclicker-macos-x86_64" ./release-files/
          fi
          if [ -f "./artifacts/autoclicker-macos-aarch64/autoclicker-macos-aarch64" ]; then
            cp "./artifacts/autoclicker-macos-aarch64/autoclicker-macos-aarch64" ./release-files/
          fi
          if [ -f "./artifacts/autoclicker-linux-x86_64/autoclicker-linux-x86_64" ]; then
            cp "./artifacts/autoclicker-linux-x86_64/autoclicker-linux-x86_64" ./release-files/
          fi
          # Make Linux/macOS binaries executable
          chmod +x ./release-files/autoclicker-* || true
          echo "Release files prepared:"
          ls -lh ./release-files/

      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release-files/*
          name: Release ${{ steps.tag.outputs.TAG_NAME }}
          body: |
            ## Features

            - **Simple GUI**: Clean interface built with egui
            - **Adjustable Click Rate**: Set clicks per second (1-100 CPS)
            - **Toggle Control**: Start and stop clicking with a single button
            - **Global Hotkey**: Press F6 anywhere to stop clicking (works even when window isn't focused)
            - **Custom Icon**: Professional app icon embedded in executable
            - **No Console Window**: Runs as a GUI application

            ## Usage

            1. Run the executable for your platform
            2. Set your desired clicks per second using the slider
            3. Position your mouse cursor where you want to click
            4. Click 'Start Clicking' to begin (1 second delay before clicking starts)
            5. Press F6 to stop clicking at any time

            ## Downloads

            - **Windows**: `autoclicker-windows-x86_64.exe`
            - **macOS (Intel)**: `autoclicker-macos-x86_64`
            - **macOS (Apple Silicon)**: `autoclicker-macos-aarch64`
            - **Linux**: `autoclicker-linux-x86_64`

            ## Building from Source

            ```bash
            cargo build --release
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
